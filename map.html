<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>HeshaN ModZ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    html, body, #map { height: 100%; margin: 0; }
    .locate-button {
      position: absolute;
      top: 15px; right: 15px; z-index: 1000;
      padding: 12px 18px; font-size: 15px; font-weight: bold;
      color: #00ff88; background-color: #000;
      border: none; border-radius: 8px; cursor: pointer;
      box-shadow: 0 0 6px rgba(0, 255, 136, 0.4);
      transition: all 0.3s ease;
    }
    .locate-button:hover {
      background-color: #002f1f;
      box-shadow: 0 0 12px rgba(0, 255, 136, 0.8);
    }
    .leaflet-popup-content button {
      margin-top: 5px;
      width: 100%;
      padding: 6px;
      font-size: 14px;
      border-radius: 5px;
      border: none;
      cursor: pointer;
    }
    .edit-btn { background: #007bff; color: white; }
    .delete-btn { background: #dc3545; color: white; }
    .mark-btn { background: #28a745; color: white; }
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="locate-button" onclick="locateMe()">üìç</div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-auth.js";
    import {
      getFirestore,
      collection,
      addDoc,
      deleteDoc,
      updateDoc,
      doc,
      getDocs,
      query,
      where
    } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyA_FQcMmyWiCxKmi8hJJaYeJGFsfrdN3ic",
      authDomain: "paytravelsl.firebaseapp.com",
      projectId: "paytravelsl",
      storageBucket: "paytravelsl.appspot.com",
      messagingSenderId: "608938101194",
      appId: "1:608938101194:web:32f3ec6e59b9cd3dad2733",
      measurementId: "G-X1C4Y174CR"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth();
    const db = getFirestore();

    let map, userLocationMarker = null;
    const markerMap = new Map();
    const MAX_TAGS = 5;

    function censorBadWords(text) {
      const badWords = ["hutto", "hukahan", "ponnaya", "ponna", "shit", "fuck", "pakaya", "labba"];
      const regex = new RegExp(badWords.join("|"), "gi");
      return text.replace(regex, (match) => "*".repeat(match.length));
    }

    onAuthStateChanged(auth, (user) => {
      if (!user || !user.emailVerified) {
        window.location.href = "index.html";
        return;
      }
      setupMap(user);
    });

    async function setupMap(user) {
      map = L.map("map", {
        center: [7.8731, 80.7718],
        zoom: 8,
        maxBounds: [[5.7, 78.0], [10.1, 83.0]],
        maxBoundsViscosity: 1.0,
        minZoom: 7,
        maxZoom: 19
      });

      L.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}", {
        maxZoom: 19
      }).addTo(map);

      const icon = (color) => new L.Icon({
        iconUrl: `https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-${color}.png`,
        shadowUrl: "https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png",
        iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
      });

      const blueIcon = icon("blue");
      const greenIcon = icon("green");
      const redIcon = icon("red");

      const tagRef = collection(db, "double_click_tags");

      async function canAddMoreTags() {
        const q = query(tagRef, where("email", "==", user.email));
        const snapshot = await getDocs(q);
        return snapshot.size < MAX_TAGS;
      }

      async function tryAddTag(lat, lng) {
        if (await canAddMoreTags()) {
          await addDoc(tagRef, {
            uid: user.uid,
            email: user.email,
            lat, lng,
            details: "",
            timestamp: Date.now()
          });
        } else {
          alert("üö´ You can only add up to 5 tags.");
        }
      }

      // ‚úÖ CHANGED: Use double-click instead of click
      map.on("dblclick", async (e) => {
        await tryAddTag(e.latlng.lat, e.latlng.lng);
      });

      setInterval(async () => {
        const snapshot = await getDocs(tagRef);
        const currentIds = new Set();

        snapshot.forEach(docSnap => {
          const data = docSnap.data();
          const id = docSnap.id;
          const isOwner = data.uid === auth.currentUser.uid;
          const currentIcon = isOwner ? blueIcon : greenIcon;
          currentIds.add(id);

          if (!markerMap.has(id)) {
            const marker = L.marker([data.lat, data.lng], { icon: currentIcon }).addTo(map);
            marker.on("click", () => showPopup(marker, id, data, isOwner));
            markerMap.set(id, { marker, data });
          } else {
            const { marker, data: oldData } = markerMap.get(id);
            if (oldData.lat !== data.lat || oldData.lng !== data.lng || oldData.details !== data.details) {
              marker.setLatLng([data.lat, data.lng]);
              marker.off("click");
              marker.on("click", () => showPopup(marker, id, data, isOwner));
              markerMap.set(id, { marker, data });
            }
          }
        });

        for (const [id, { marker }] of markerMap.entries()) {
          if (!currentIds.has(id)) {
            map.removeLayer(marker);
            markerMap.delete(id);
          }
        }
      }, 1000);

      window.locateMe = () => {
        map.locate({ setView: false });
        map.once("locationfound", (e) => {
          const { lat, lng } = e.latlng;
          if (userLocationMarker) map.removeLayer(userLocationMarker);
          userLocationMarker = L.marker([lat, lng], { icon: redIcon }).addTo(map);

          const content = document.createElement("div");
          content.innerHTML = `<b>Your Location</b>`;
          const btn = document.createElement("button");
          btn.textContent = "Mark Here";
          btn.className = "mark-btn";
          btn.onclick = async () => {
            await tryAddTag(lat, lng);
          };
          content.appendChild(btn);
          userLocationMarker.bindPopup(content).openPopup();

          map.flyTo([lat, lng], 16, { animate: true, duration: 1.5 });
        });
        map.on("locationerror", () => alert("‚ùå Location access denied."));
      };

      function showPopup(marker, id, data, isOwner) {
        const div = document.createElement("div");
        div.innerHTML = `<b>${data.email}</b><br>`;
        const cleanDetails = censorBadWords(data.details || "");
        if (cleanDetails) div.innerHTML += `<i>${cleanDetails}</i><br>`;

        if (isOwner) {
          const editBtn = document.createElement("button");
          editBtn.textContent = "Add Details";
          editBtn.className = "edit-btn";
          editBtn.onclick = async () => {
            const input = prompt("Enter details:", data.details || "");
            if (input !== null) {
              const cleanInput = censorBadWords(input);
              await updateDoc(doc(db, "double_click_tags", id), { details: cleanInput });
            }
          };
          div.appendChild(editBtn);

          const deleteBtn = document.createElement("button");
          deleteBtn.textContent = "Remove";
          deleteBtn.className = "delete-btn";
          deleteBtn.onclick = async () => {
            await deleteDoc(doc(db, "double_click_tags", id));
          };
          div.appendChild(deleteBtn);
        }

        marker.bindPopup(div).openPopup();
      }
    }
  </script>
</body>
</html>
